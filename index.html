<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ê¸°ì°¨í‘œ ì¼ì • ë‹¬ë ¥</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì • ë° ì´ˆê¸°í™”
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ì „ì—­ ë³€ìˆ˜ë¡œ Firebase ì¸ìŠ¤í„´ìŠ¤ ë…¸ì¶œ
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User signed in:", user.uid);
                window.currentUserId = user.uid;
                document.getElementById('userIdDisplay').textContent = `ì‚¬ìš©ì ID: ${user.uid}`;
                renderCalendar(); // ì¸ì¦ í›„ ë‹¬ë ¥ ë Œë”ë§
                setupFirestoreListener(); // Firestore ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            } else {
                console.log("No user signed in. Signing in anonymously...");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    // ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì„ì‹œ ì‚¬ìš©ì ID ìƒì„±
                    window.currentUserId = crypto.randomUUID();
                    document.getElementById('userIdDisplay').textContent = `ì‚¬ìš©ì ID: ${window.currentUserId} (ìµëª…)`;
                    renderCalendar();
                    setupFirestoreListener();
                }
            }
        });

        // Firestore ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜
        function setupFirestoreListener() {
            if (!window.firebaseDb || !window.currentUserId) {
                console.warn("Firestore or User ID not ready for listener setup.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const schedulesColRef = collection(window.firebaseDb, `artifacts/${appId}/public/data/trainSchedules`);
            const q = query(schedulesColRef);

            onSnapshot(q, (snapshot) => {
                const fetchedSchedules = [];
                snapshot.forEach(document => {
                    fetchedSchedules.push({ id: document.id, ...document.data() });
                });
                // Sort by date (oldest first)
                fetchedSchedules.sort((a, b) => new Date(a.date) - new Date(b.date));
                window.trainSchedules = fetchedSchedules; // Update global variable
                renderCalendar(); // Re-render calendar on data change
            }, (error) => {
                console.error("Error fetching documents: ", error);
            });
        }

        // Add new schedule to Firestore
        window.addScheduleToFirestore = async (scheduleData) => {
            if (!window.firebaseDb || !window.currentUserId) {
                console.error("Firestore or User ID not ready. Cannot add schedule.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                await addDoc(collection(window.firebaseDb, `artifacts/${appId}/public/data/trainSchedules`), {
                    ...scheduleData,
                    userId: window.currentUserId, // Record who added it
                    timestamp: serverTimestamp() // Record server timestamp
                });
                console.log("Document successfully written!");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        // Update existing schedule in Firestore
        window.updateScheduleInFirestore = async (id, data) => {
            if (!window.firebaseDb || !window.currentUserId) {
                console.error("Firestore or User ID not ready. Cannot update schedule.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const docRef = doc(window.firebaseDb, `artifacts/${appId}/public/data/trainSchedules`, id);
                await updateDoc(docRef, data);
                console.log("Document successfully updated!");
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        };

        // Delete schedule from Firestore
        window.deleteScheduleFromFirestore = async (id) => {
            if (!window.firebaseDb || !window.currentUserId) {
                console.error("Firestore or User ID not ready. Cannot delete schedule.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const docRef = doc(window.firebaseDb, `artifacts/${appId}/public/data/trainSchedules`, id);
                await deleteDoc(docRef);
                console.log("Document successfully deleted!");
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Container styles */
        .container {
            width: 100%;
            max-width: 800px; /* Adjusted width for single month */
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
        }

        /* Title styles */
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 35px;
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: -0.8px;
        }

        /* User ID display */
        #userIdDisplay {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #666;
        }

        /* Admin mode toggle button */
        #adminModeToggle {
            background-color: #007bff; /* Blue for admin toggle */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: block; /* Make it a block element */
            margin-left: auto;
            margin-right: auto;
        }
        #adminModeToggle.active {
            background-color: #28a745; /* Green when active */
        }
        #adminModeToggle:hover {
            transform: translateY(-1px);
        }

        /* Month selector and buttons */
        .month-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 15px;
        }
        .month-selector button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .month-selector button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }
        .month-selector span {
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
        }

        /* Calendar container (single month) */
        .calendar-grid-container {
            display: flex;
            justify-content: center; /* Center align */
        }

        /* Individual month calendar styles */
        .month-calendar {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            width: 100%; /* Match container width */
            max-width: 600px; /* Max width for single month */
        }

        .month-header {
            background-color: #4CAF50;
            color: white;
            padding: 12px 0;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #388E3C;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #f8f8f8;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .weekdays div {
            text-align: center;
            font-weight: bold;
            color: #666;
            font-size: 0.85em;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex-grow: 1; /* Fill remaining space */
        }

        .day {
            min-height: 80px; /* Min height for each day cell */
            border: 1px solid #f0f0f0;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #fff;
            transition: background-color 0.2s ease;
        }
        .day:hover {
            background-color: #f9f9f9;
        }

        .day.empty {
            background-color: #fcfcfc;
        }

        .day-number {
            font-weight: bold;
            font-size: 1.1em;
            color: #444;
            margin-bottom: 5px;
        }

        /* Weekend colors */
        .day:nth-child(7n) .day-number { /* Saturday */
            color: #007bff; /* Blue */
        }
        .day:nth-child(7n+1) .day-number { /* Sunday */
            color: #dc3545; /* Red */
        }

        /* Event styles */
        .event {
            background-color: #e6ffe6; /* Light green background */
            border-left: 3px solid #4CAF50; /* Green left border */
            padding: 4px 6px;
            margin-bottom: 3px;
            border-radius: 4px;
            font-size: 0.8em;
            line-height: 1.3;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .event:hover {
            background-color: #d9f2d9;
        }
        .event-time {
            font-weight: 600;
            color: #555;
        }
        .event-route {
            color: #666;
        }

        /* Ticket status colors */
        .event.status-ì˜ˆë§¤ì™„ë£Œ {
            border-left-color: #28a745; /* Dark green */
            background-color: #e6ffe6; /* Light green */
        }
        .event.status-ì˜ˆë§¤ëŒ€ê¸° {
            border-left-color: #ffc107; /* Orange */
            background-color: #fffbe6; /* Light orange */
        }
        .event.status-ì˜ˆë§¤ë¶ˆê°€ëŠ¥ {
            border-left-color: #dc3545; /* Red */
            background-color: #ffe6e6; /* Light red */
        }
        .event.status-ë°œê¶Œìš”ì²­ë¨ {
            border-left-color: #007bff; /* Blue */
            background-color: #e6f2ff; /* Light blue */
        }
        .event.status-ì·¨ì†Œìš”ì²­ë¨ {
            border-left-color: #6f42c1; /* Purple */
            background-color: #f2e6ff; /* Light purple */
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }
        .modal-content p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .modal-content p strong {
            color: #555;
            display: inline-block;
            width: 90px; /* Fixed label width */
        }
        .modal-content .status-ì˜ˆë§¤ì™„ë£Œ, .modal-content .status-ì˜ˆë§¤ëŒ€ê¸°, .modal-content .status-ì˜ˆë§¤ë¶ˆê°€ëŠ¥,
        .modal-content .status-ë°œê¶Œìš”ì²­ë¨, .modal-content .status-ì·¨ì†Œìš”ì²­ë¨ {
            font-weight: bold;
        }

        /* Modal action buttons */
        .modal-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .modal-actions button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 120px; /* Minimum width for buttons */
        }
        .modal-actions button.confirm-btn { background-color: #28a745; } /* Green */
        .modal-actions button.request-btn { background-color: #007bff; } /* Blue */
        .modal-actions button.delete-btn { background-color: #dc3545; } /* Red */
        .modal-actions button.reject-btn { background-color: #6c757d; } /* Gray */

        .modal-actions button:hover {
            transform: translateY(-1px);
        }

        /* Input form styles */
        .input-form {
            background-color: #f8f8f8;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 15px;
        }
        .input-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }
        .input-form input[type="date"],
        .input-form input[type="time"],
        .input-form input[type="text"],
        .input-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }
        .input-form input:focus,
        .input-form select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        .input-form .full-width {
            grid-column: 1 / -1; /* Occupy full width */
        }
        .input-form button {
            grid-column: 1 / -1; /* Occupy full width */
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }
        .input-form button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        /* Custom Alert/Confirmation Modal */
        .custom-dialog {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002; /* Above event modal */
            justify-content: center;
            align-items: center;
        }
        .custom-dialog-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        .custom-dialog-content p {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #333;
        }
        .custom-dialog-content .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .custom-dialog-content button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .custom-dialog-content button.cancel {
            background-color: #6c757d;
        }
        .custom-dialog-content button:hover {
            opacity: 0.9;
        }
        .custom-dialog-content input[type="password"] {
            width: calc(100% - 20px); /* Adjust width */
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }


        /* Responsive design */
        @media (max-width: 768px) {
            .month-calendar {
                max-width: 100%;
            }
            .input-form {
                grid-template-columns: 1fr; /* Single column on mobile */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš‚ ìš°ë¦¬ ê¸°ì°¨í‘œ ì¼ì • ë‹¬ë ¥ ğŸš‚</h1>
        <div id="userIdDisplay">ì‚¬ìš©ì ID: ë¡œë”© ì¤‘...</div>

        <button id="adminModeToggle">ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”</button>

        <div class="input-form" style="display: none;"> <h2 class="full-width">ìƒˆ ê¸°ì°¨í‘œ ì¼ì • ì¶”ê°€</h2>
            <div>
                <label for="scheduleDate">ë‚ ì§œ:</label>
                <input type="date" id="scheduleDate" required>
            </div>
            <div>
                <label for="scheduleTime">ì‹œê°„:</label>
                <input type="time" id="scheduleTime" required>
            </div>
            <div>
                <label for="trainType">ê¸°ì°¨ ì¢…ë¥˜:</label>
                <select id="trainType" required>
                    <option value="">ì„ íƒ</option>
                    <option value="KTX">KTX</option>
                    <option value="SRT">SRT</option>
                </select>
            </div>
            <div>
                <label for="trainRoute">ë…¸ì„ :</label>
                <select id="trainRoute" required>
                    <option value="">ê¸°ì°¨ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div>
                <label for="scheduleStatus">ë°œê¶Œ ìƒíƒœ:</label>
                <select id="scheduleStatus" required>
                    <option value="ì˜ˆë§¤ëŒ€ê¸°">ì˜ˆë§¤ëŒ€ê¸°</option>
                    <option value="ì˜ˆë§¤ì™„ë£Œ">ì˜ˆë§¤ì™„ë£Œ</option>
                    <option value="ì˜ˆë§¤ë¶ˆê°€ëŠ¥">ì˜ˆë§¤ë¶ˆê°€ëŠ¥</option>
                </select>
            </div>
            <button id="addScheduleBtn" class="full-width">ì¼ì • ì¶”ê°€</button>
        </div>

        <div class="month-selector">
            <button id="prevMonth">&lt; ì´ì „ ì›”</button>
            <span id="currentMonthYear"></span>
            <button id="nextMonth">ë‹¤ìŒ ì›” &gt;</button>
        </div>

        <div id="calendarContainer" class="calendar-grid-container">
            </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalDate"></h3>
            <p><strong>ì‹œê°„:</strong> <span id="modalTime"></span></p>
            <p><strong>ê¸°ì°¨ ì¢…ë¥˜:</strong> <span id="modalTrainType"></span></p>
            <p><strong>ë…¸ì„ :</strong> <span id="modalRoute"></span></p>
            <p><strong>ë°œê¶Œ ìƒíƒœ:</strong> <span id="modalStatus"></span></p>
            <p id="modalRequestedByLine" style="display: none;"><strong>ìš”ì²­ì:</strong> <span id="modalRequestedBy"></span></p>
            <div class="modal-actions">
                </div>
        </div>
    </div>

    <div id="customAlertDialog" class="custom-dialog">
        <div class="custom-dialog-content">
            <p id="alertDialogMessage"></p>
            <div class="dialog-buttons">
                <button id="alertDialogOk">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="customPromptDialog" class="custom-dialog">
        <div class="custom-dialog-content">
            <p id="promptDialogMessage"></p>
            <input type="password" id="promptDialogInput" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <div class="dialog-buttons">
                <button id="promptDialogOk">í™•ì¸</button>
                <button id="promptDialogCancel" class="cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ê¸°ì°¨í‘œ ì¼ì • ì „ì—­ ë³€ìˆ˜ (Firestoreì—ì„œ ê°€ì ¸ì˜¬ ë•Œê¹Œì§€ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”)
        window.trainSchedules = [];

        const calendarContainer = document.getElementById('calendarContainer');
        const currentMonthYearSpan = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        // í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œí•  ì—°ë„ì™€ ì›”ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        const today = new Date();
        let displayYear = today.getFullYear();
        let displayMonth = today.getMonth(); // 0-11

        // ëª¨ë‹¬ ìš”ì†Œ
        const eventModal = document.getElementById('eventModal');
        const closeButton = document.querySelector('.close-button');
        const modalDate = document.getElementById('modalDate');
        const modalTime = document.getElementById('modalTime');
        const modalTrainType = document.getElementById('modalTrainType');
        const modalRoute = document.getElementById('modalRoute');
        const modalStatus = document.getElementById('modalStatus');
        const modalRequestedByLine = document.getElementById('modalRequestedByLine');
        const modalRequestedBy = document.getElementById('modalRequestedBy');
        const modalActionsDiv = eventModal.querySelector('.modal-actions');

        // ì…ë ¥ í¼ ìš”ì†Œ
        const adminModeToggle = document.getElementById('adminModeToggle');
        const inputForm = document.querySelector('.input-form');
        let isAdminMode = false; // ê´€ë¦¬ì ëª¨ë“œ ìƒíƒœ

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
        const ADMIN_PASSWORD = "0000";

        const scheduleDateInput = document.getElementById('scheduleDate');
        const scheduleTimeInput = document.getElementById('scheduleTime');
        const trainTypeSelect = document.getElementById('trainType');
        const trainRouteSelect = document.getElementById('trainRoute');
        const scheduleStatusSelect = document.getElementById('scheduleStatus');
        const addScheduleBtn = document.getElementById('addScheduleBtn');

        // ì‚¬ìš©ì ì •ì˜ ì•Œë¦¼/í™•ì¸ ëŒ€í™” ìƒì ìš”ì†Œ
        const customAlertDialog = document.getElementById('customAlertDialog');
        const alertDialogMessage = document.getElementById('alertDialogMessage');
        const alertDialogOk = document.getElementById('alertDialogOk');

        // ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸ ëŒ€í™” ìƒì ìš”ì†Œ
        const customPromptDialog = document.getElementById('customPromptDialog');
        const promptDialogMessage = document.getElementById('promptDialogMessage');
        const promptDialogInput = document.getElementById('promptDialogInput');
        const promptDialogOk = document.getElementById('promptDialogOk');
        const promptDialogCancel = document.getElementById('promptDialogCancel');
        let promptCallback = null; // í”„ë¡¬í”„íŠ¸ ì½œë°±

        // ì‚¬ìš©ì ì •ì˜ ì•Œë¦¼ í•¨ìˆ˜
        function showAlert(message) {
            alertDialogMessage.textContent = message;
            customAlertDialog.style.display = 'flex';
        }
        alertDialogOk.onclick = () => {
            customAlertDialog.style.display = 'none';
        };

        // ì‚¬ìš©ì ì •ì˜ í”„ë¡¬í”„íŠ¸ í•¨ìˆ˜ (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ìš©)
        function showPrompt(message, callback) {
            promptDialogMessage.textContent = message;
            promptDialogInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            customPromptDialog.style.display = 'flex';
            promptDialogInput.focus(); // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            promptCallback = callback;
        }
        promptDialogOk.onclick = () => {
            customPromptDialog.style.display = 'none';
            if (promptCallback) promptCallback(promptDialogInput.value);
        };
        promptDialogCancel.onclick = () => {
            customPromptDialog.style.display = 'none';
            if (promptCallback) promptCallback(null); // ì·¨ì†Œ ì‹œ null ë°˜í™˜
        };


        // ëª¨ë‹¬ ë‹«ê¸°
        closeButton.onclick = function() {
            eventModal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == eventModal) {
                eventModal.style.display = 'none';
            }
        }

        /**
         * ì£¼ì–´ì§„ ì—°ë„ì™€ ì›”ì— ëŒ€í•œ ë‹¬ë ¥ì„ ìƒì„±í•©ë‹ˆë‹¤.
         * @param {number} year - ì—°ë„
         * @param {number} month - ì›” (0-11)
         * @returns {HTMLElement} ìƒì„±ëœ ì›” ë‹¬ë ¥ ìš”ì†Œ
         */
        function createMonthCalendar(year, month) {
            const monthNames = [
                '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”',
                '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'
            ];
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            const monthCalendar = document.createElement('div');
            monthCalendar.classList.add('month-calendar');

            const monthHeader = document.createElement('div');
            monthHeader.classList.add('month-header');
            monthHeader.textContent = `${year}ë…„ ${monthNames[month]}`;
            monthCalendar.appendChild(monthHeader);

            const weekdaysDiv = document.createElement('div');
            weekdaysDiv.classList.add('weekdays');
            dayNames.forEach(dayName => {
                const dayDiv = document.createElement('div');
                dayDiv.textContent = dayName;
                weekdaysDiv.appendChild(dayDiv);
            });
            monthCalendar.appendChild(weekdaysDiv);

            const daysDiv = document.createElement('div');
            daysDiv.classList.add('days');
            monthCalendar.appendChild(daysDiv);

            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0:ì¼, 1:ì›”, ..., 6:í† 
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ

            // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day', 'empty');
                daysDiv.appendChild(emptyDay);
            }

            // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œ ì±„ìš°ê¸°
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('day');

                const dayNumber = document.createElement('div');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                dayDiv.appendChild(dayNumber);

                // í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì°¨í‘œ ì¼ì • ì°¾ê¸°
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const eventsOnThisDay = (window.trainSchedules || []).filter(schedule => schedule.date === fullDate);

                eventsOnThisDay.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('event');
                    // ìƒˆ ìƒíƒœ í´ë˜ìŠ¤ ì ìš©
                    eventDiv.classList.add(`status-${event.status}`);
                    eventDiv.innerHTML = `
                        <span class="event-time">${event.time}</span>
                        <span class="event-route">${event.trainType} ${event.route}</span>
                    `;

                    // ì´ë²¤íŠ¸ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ
                    eventDiv.addEventListener('click', () => {
                        modalDate.textContent = `${year}ë…„ ${month + 1}ì›” ${day}ì¼`;
                        modalTime.textContent = event.time;
                        modalTrainType.textContent = event.trainType;
                        modalRoute.textContent = event.route;
                        modalStatus.textContent = event.status;
                        modalStatus.className = ''; // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
                        modalStatus.classList.add(`status-${event.status}`); // ìƒˆ ìƒíƒœ í´ë˜ìŠ¤ ì ìš©

                        // ìš”ì²­ì ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                        if (event.requestedBy) {
                            modalRequestedByLine.style.display = 'block';
                            modalRequestedBy.textContent = event.requestedBy;
                        } else {
                            modalRequestedByLine.style.display = 'none';
                            modalRequestedBy.textContent = '';
                        }
                        
                        // ì´ì „ ë²„íŠ¼ ëª¨ë‘ ì œê±°
                        modalActionsDiv.innerHTML = '';

                        // ê´€ë¦¬ì ëª¨ë“œ ë° ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ì¶”ê°€
                        if (isAdminMode) {
                            // ê´€ë¦¬ì ì‘ì—…
                            const confirmBtn = document.createElement('button');
                            confirmBtn.textContent = 'ì˜ˆë§¤ í™•ì¸';
                            confirmBtn.classList.add('confirm-btn');
                            confirmBtn.addEventListener('click', async () => {
                                await window.updateScheduleInFirestore(event.id, { status: 'ì˜ˆë§¤ì™„ë£Œ', requestedBy: null });
                                eventModal.style.display = 'none';
                            });

                            const deleteBtn = document.createElement('button'); // ì˜ˆë§¤ ì‚­ì œ ë²„íŠ¼
                            deleteBtn.textContent = 'ì˜ˆë§¤ ì‚­ì œ';
                            deleteBtn.classList.add('delete-btn');
                            deleteBtn.addEventListener('click', () => {
                                showAlert('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async (confirmed) => {
                                    if (confirmed) {
                                        await window.deleteScheduleFromFirestore(event.id);
                                        eventModal.style.display = 'none';
                                    }
                                });
                            });

                            const rejectBtn = document.createElement('button');
                            rejectBtn.textContent = 'ìš”ì²­ ê±°ë¶€';
                            rejectBtn.classList.add('reject-btn');
                            rejectBtn.addEventListener('click', async () => {
                                let newStatus = 'ì˜ˆë§¤ëŒ€ê¸°'; // ê¸°ë³¸ì ìœ¼ë¡œ ëŒ€ê¸°ë¡œ ê±°ë¶€
                                if (event.status === 'ì·¨ì†Œìš”ì²­ë¨') {
                                    newStatus = 'ì˜ˆë§¤ì™„ë£Œ'; // ì·¨ì†Œ ìš”ì²­ì´ë©´ ì˜ˆë§¤ì™„ë£Œë¡œ ë˜ëŒë¦¼
                                }
                                await window.updateScheduleInFirestore(event.id, { status: newStatus, requestedBy: null });
                                eventModal.style.display = 'none';
                            });

                            modalActionsDiv.appendChild(confirmBtn);
                            modalActionsDiv.appendChild(deleteBtn); // ì˜ˆë§¤ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                            // ìš”ì²­ ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°ì—ë§Œ ìš”ì²­ ê±°ë¶€ ë²„íŠ¼ í‘œì‹œ
                            if (event.status === 'ë°œê¶Œìš”ì²­ë¨' || event.status === 'ì·¨ì†Œìš”ì²­ë¨') {
                                modalActionsDiv.appendChild(rejectBtn);
                            }

                        } else {
                            // ì¼ë°˜ ì‚¬ìš©ì ì‘ì—… (ìš”ì²­)
                            if (event.status === 'ì˜ˆë§¤ëŒ€ê¸°') {
                                const requestBookBtn = document.createElement('button');
                                requestBookBtn.textContent = 'ë°œê¶Œ ìš”ì²­';
                                requestBookBtn.classList.add('request-btn');
                                requestBookBtn.addEventListener('click', async () => {
                                    await window.updateScheduleInFirestore(event.id, { status: 'ë°œê¶Œìš”ì²­ë¨', requestedBy: window.currentUserId });
                                    eventModal.style.display = 'none';
                                });
                                modalActionsDiv.appendChild(requestBookBtn);
                            } else if (event.status === 'ì˜ˆë§¤ì™„ë£Œ') {
                                const requestCancelBtn = document.createElement('button');
                                requestCancelBtn.textContent = 'ì·¨ì†Œ ìš”ì²­';
                                requestCancelBtn.classList.add('request-btn');
                                requestCancelBtn.addEventListener('click', async () => {
                                    await window.updateScheduleInFirestore(event.id, { status: 'ì·¨ì†Œìš”ì²­ë¨', requestedBy: window.currentUserId });
                                    eventModal.style.display = 'none';
                                });
                                modalActionsDiv.appendChild(requestCancelBtn);
                            }
                        }

                        eventModal.style.display = 'flex'; // ëª¨ë‹¬ í‘œì‹œ
                    });

                    dayDiv.appendChild(eventDiv);
                });

                daysDiv.appendChild(dayDiv);
            }

            return monthCalendar;
        }

        /**
         * í˜„ì¬ displayYearì™€ displayMonthë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¬ë ¥ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderCalendar() {
            calendarContainer.innerHTML = ''; // ê¸°ì¡´ ë‹¬ë ¥ ì§€ìš°ê¸°
            currentMonthYearSpan.textContent = `${displayYear}ë…„ ${displayMonth + 1}ì›”`; // í‘œì‹œë˜ëŠ” ì›” ì—…ë°ì´íŠ¸

            // í˜„ì¬ ì›” ë‹¬ë ¥ë§Œ ë Œë”ë§
            const monthCalendar = createMonthCalendar(displayYear, displayMonth);
            calendarContainer.appendChild(monthCalendar);
        }

        // ì´ˆê¸° ë Œë”ë§ (ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆì—ì„œ í˜¸ì¶œë  ê²ƒ)
        // renderCalendar();

        // ì´ì „ ì›” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        prevMonthBtn.addEventListener('click', () => {
            displayMonth--;
            if (displayMonth < 0) { // 1ì›”ì—ì„œ ì´ì „ ì›”ë¡œ ê°€ë©´ ì´ì „ ì—°ë„ 12ì›”ë¡œ
                displayMonth = 11;
                displayYear--;
            }
            renderCalendar();
        });

        // ë‹¤ìŒ ì›” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        nextMonthBtn.addEventListener('click', () => {
            displayMonth++;
            if (displayMonth > 11) { // 12ì›”ì—ì„œ ë‹¤ìŒ ì›”ë¡œ ê°€ë©´ ë‹¤ìŒ ì—°ë„ 1ì›”ë¡œ
                displayMonth = 0;
                displayYear++;
            }
            renderCalendar();
        });

        // ê¸°ì°¨ ì¢…ë¥˜ ì„ íƒì— ë”°ë¥¸ ë…¸ì„  ì—…ë°ì´íŠ¸
        trainTypeSelect.addEventListener('change', () => {
            const selectedType = trainTypeSelect.value;
            trainRouteSelect.innerHTML = '<option value="">ë…¸ì„  ì„ íƒ</option>'; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”

            if (selectedType === 'KTX') {
                const option = document.createElement('option');
                option.value = 'ì°½ì›ì¤‘ì•™ â†’ ë™ì„œìš¸';
                option.textContent = 'ì°½ì›ì¤‘ì•™ â†’ ë™ì„œìš¸';
                trainRouteSelect.appendChild(option);
            } else if (selectedType === 'SRT') {
                const option1 = document.createElement('option');
                option1.value = 'ë™ì„œìš¸ â†’ ìˆ˜ì„œ';
                option1.textContent = 'ë™ì„œìš¸ â†’ ìˆ˜ì„œ';
                trainRouteSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = 'ìˆ˜ì„œ â†’ ì°½ì›ì¤‘ì•™';
                option2.textContent = 'ìˆ˜ì„œ â†’ ì°½ì›ì¤‘ì•™';
                trainRouteSelect.appendChild(option2);
            }
        });

        // ì¼ì • ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        addScheduleBtn.addEventListener('click', async () => {
            const date = scheduleDateInput.value;
            const time = scheduleTimeInput.value;
            const trainType = trainTypeSelect.value;
            const route = trainRouteSelect.value;
            const status = scheduleStatusSelect.value;

            if (!date || !time || !trainType || !route || !status) {
                showAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); // showAlert í•¨ìˆ˜ ì‚¬ìš©
                return;
            }

            const newSchedule = {
                date,
                time,
                trainType,
                route,
                status,
            };

            // Firestoreì— ì¼ì • ì¶”ê°€
            await window.addScheduleToFirestore(newSchedule);

            // í¼ ì´ˆê¸°í™”
            scheduleDateInput.value = '';
            scheduleTimeInput.value = '';
            trainTypeSelect.value = '';
            trainRouteSelect.innerHTML = '<option value="">ê¸°ì°¨ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            scheduleStatusSelect.value = 'ì˜ˆë§¤ëŒ€ê¸°';
        });

        // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        adminModeToggle.addEventListener('click', () => {
            if (isAdminMode) {
                // ê´€ë¦¬ì ëª¨ë“œ ë¹„í™œì„±í™”
                isAdminMode = false;
                inputForm.style.display = 'none'; // í¼ ìˆ¨ê¸°ê¸°
                adminModeToggle.textContent = 'ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”';
                adminModeToggle.classList.remove('active');
                renderCalendar(); // ëª¨ë‹¬ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë‹¬ë ¥ ë‹¤ì‹œ ë Œë”ë§
            } else {
                // ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™” ì‹œë„
                showPrompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', (input) => {
                    if (input === ADMIN_PASSWORD) {
                        isAdminMode = true;
                        inputForm.style.display = 'grid'; // í¼ í‘œì‹œ
                        adminModeToggle.textContent = 'ê´€ë¦¬ì ëª¨ë“œ ë¹„í™œì„±í™”';
                        adminModeToggle.classList.add('active');
                        renderCalendar(); // ëª¨ë‹¬ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë‹¬ë ¥ ë‹¤ì‹œ ë Œë”ë§
                    } else if (input !== null) { // 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ì§€ ì•Šì•˜ì„ ê²½ìš°ì—ë§Œ ë©”ì‹œì§€ í‘œì‹œ
                        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                    }
                });
            }
        });
    </script>
</body>
</html>
